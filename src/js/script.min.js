function getDeviceId(){const t=FingerprintJS.load({apiKey:"a1ZJOENnGt4QCgAqBHHb",region:"eu",endpoint:"https://fp.withamscouts.org.uk"});t.then(t=>t.get()).then(t=>{null===localStorage.getItem("deviceId")&&localStorage.setItem("deviceId",t.visitorId)}).catch(t=>{console.warn(t)})}function showError(t,e){console.log(`Showing error message: ${t}`),e?Swal.fire({title:"Application error",text:t,icon:"error",buttonsStyling:!1,customClass:{confirmButton:"btn btn-primary"},didOpen:()=>{Swal.hideLoading()}}):Swal.fire({title:"Application error",text:t,icon:"error",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1,didOpen:()=>{Swal.hideLoading()}})}function setLoadingIndicator(t,e){t?(console.log("Show full screen loading indicator"),Swal.fire({title:`${e}...`,showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1,customClass:{loader:"custom-loader"},loaderHtml:'<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>',didOpen:()=>{Swal.showLoading()}})):(console.log("Remove full screen loading indicator"),Swal.close())}function prettyDate(t){const e=["January","February","March","April","May","June","July","August","September","October","November","December"],n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a=new Date(t),o=e[a.getMonth()],i=n[a.getDay()],r=String(a.getDate()),c=`${r}${"1"===r||"21"===r||"31"===r?"st":"2"===r||"22"===r?"nd":"3"===r||"23"===r?"rd":"th"}`;return`${i} ${c} of ${o} ${a.getFullYear()}`}function handleErrors(t){if(t.hasOwnProperty("error"))throw Error(t.error);if(t.hasOwnProperty("errorMessage"))throw Error(`${t.errorType}: ${t.errorMessage}`);return t}function loadCachesPage(){const t=document.getElementById("mapContainer");t.innerHTML='<div class="text-center">\n\t\t\t<img src="./img/loading.gif" class="img-fluid text-center"\n\t\t\t\talt="Loading animation placeholder">\n\t\t</div>';const e=new google.maps.plugins.loader.Loader({apiKey:"AIzaSyDoWhwCiUGlBzrTOFxS17QUjBT9-eh46C4",version:"quarterly",libraries:["drawing"],language:"en",region:"GB",id:"googleMapsScript"});let n;fetch("./api/get-caches",{method:"GET",headers:{"Device-Id":localStorage.getItem("deviceId")}}).then(t=>t.json()).then(handleErrors).then(t=>{if(!t.hasOwnProperty("caches"))throw"No caches found";return n=t.caches,e.load()}).then(n=>(t.innerHTML="",mainMap=new n.maps.Map(t,{center:{lat:51.80007,lng:.64038},zoom:14.3,restriction:{latLngBounds:{north:51.826601357825716,east:.7474966992187326,south:51.773523020732,west:.5332633007812326},strictBounds:!0},mapId:"6b8e857a992e95a7",streetViewControl:!1,mapTypeControl:!1}),e.load())).then(t=>{try{const e=n.map(e=>{const n=new t.maps.Marker({position:{lat:Number(e.coordinates.split(",")[0]),lng:Number(e.coordinates.split(",")[1])},map:mainMap,title:`Cache ${e.id}`,label:{text:e.id,color:"#ffffff",fontSize:"16px"},animation:t.maps.Animation.DROP,icon:{url:e.found?"./img/found.png":"./img/notFound.png",labelOrigin:new t.maps.Point(22,20)},optimized:!0});return n.addListener("click",()=>{router.navigate(`/viewCache-${e.id}`)}),n});new markerClusterer.MarkerClusterer({map:mainMap,markers:e})}catch(t){throw console.warn(t),"Unable to load caches"}}).catch(t=>{showError(t,!1)}),changePage("map","View caches")}function loadCachePage(t){resetCachePage(),fetch("./api/get-cache",{method:"POST",body:JSON.stringify({cache:t}),headers:{"Content-Type":"application/json","Device-Id":localStorage.getItem("deviceId")}}).then(t=>t.json()).then(handleErrors).then(e=>{document.getElementById("cacheCard").removeAttribute("aria-hidden");const n=document.getElementById("cacheMapImg");n.setAttribute("src",`${DOMPurify.sanitize(e.image)}`),n.setAttribute("alt",`Map for Cache ${t}`);const a=document.getElementById("cacheHeader");a.setAttribute("class","card-title"),a.innerHTML="",a.innerText=`Cache ${t}`;const o=document.getElementById("cacheW3WLink");o.setAttribute("class","card-text");const i=String(DOMPurify.sanitize(e.location)).split("///")[1];o.innerHTML=`what3words address: <a href="https://what3words.com/${i}" target="_blank" translate="no">///${i}</a><br><br><strong id="cacheStats"></strong>`;const r=document.getElementById("cacheW3WBtn");r.removeAttribute("tabindex"),r.setAttribute("class","btn btn-primary m-1"),r.setAttribute("href",`https://what3words.com/${i}`),r.setAttribute("target","_blank"),r.innerHTML='<i class="bi bi-geo-alt" aria-hidden="true"></i>&nbsp;Open in What3Words';const c=document.getElementById("cacheMapsLink");c.removeAttribute("tabindex"),c.setAttribute("class","btn btn-primary m-1"),c.setAttribute("href",`https://www.google.com/maps/dir/?api=1&destination=${DOMPurify.sanitize(e.coordinates)}&travelmode=walking`),c.setAttribute("target","_blank"),c.innerHTML='<i class="bi bi-geo-alt" aria-hidden="true"></i>&nbsp;Open in Google Maps';const s=document.getElementById("cacheFoundLink"),d=document.getElementById("cacheStats");e.found?(s.setAttribute("class","btn btn-outline-primary m-1 disabled"),s.innerHTML='<i class="bi bi-patch-check" aria-hidden="true"></i>&nbsp;You\'ve already found this cache',d.innerText=`You ${1===Number(e.stats)?"are the only person that has found this cache!":`and ${Number(e.stats)-1} other ${Number(e.stats)-1==1?"person has":"people have"} found this cache`}`):(s.setAttribute("class","btn btn-outline-primary m-1"),s.setAttribute("href",`foundCache-${t}`),s.innerHTML='<i class="bi bi-123" aria-hidden="true"></i>&nbsp;Found this cache?',d.innerText=`${0===Number(e.stats)?"No one has found this cache yet. Can you find it?":`${Number(e.stats)} ${1===Number(e.stats)?"person has":"people have"} found this cache - can you find it?`}`,s.onclick=function(){router.navigate(`/foundCache-${t}`)})}).catch(t=>{showError(t,!1)}),changePage("cache",`Cache ${t}`)}function changePage(t,e){document.querySelectorAll("a.nav-link").forEach(e=>{e.getAttribute("data-page")===t?(e.setAttribute("class","nav-link active"),e.setAttribute("aria-current","page")):(e.setAttribute("class","nav-link"),e.removeAttribute("aria-current"))}),document.querySelectorAll("section").forEach(e=>{e.id!==t&&(e.setAttribute("class","row mx-auto d-none"),e.setAttribute("aria-hidden","true"))}),document.getElementById(t).setAttribute("class","row mx-auto"),document.getElementById(t).setAttribute("aria-hidden","false"),document.title=`${e} | Witham Scouts Geocaching`}function resetCachePage(){document.getElementById("cacheCard").setAttribute("aria-hidden","true");const t=document.getElementById("cacheMapImg");t.setAttribute("src","./img/loading.gif"),t.setAttribute("alt","Loading animation placeholder");const e=document.getElementById("cacheHeader");e.setAttribute("class","card-title placeholder-glow"),e.innerHTML='<span class="placeholder col-6"></span>';const n=document.getElementById("cacheW3WLink");n.setAttribute("class","card-text placeholder-glow"),n.innerHTML='<span class="placeholder col-7"></span><span class="placeholder col-4"></span><span class="placeholder col-4"></span><span class="placeholder col-6"></span><span class="placeholder col-8"></span>';const a=document.getElementById("cacheW3WBtn");a.removeAttribute("target"),a.setAttribute("href","#"),a.setAttribute("tabindex","-1"),a.setAttribute("class","btn btn-primary m-1 disabled placeholder col-5"),a.innerHTML="";const o=document.getElementById("cacheMapsLink");o.removeAttribute("target"),o.setAttribute("href","#"),o.setAttribute("tabindex","-1"),o.setAttribute("class","btn btn-primary m-1 disabled placeholder col-5"),o.innerHTML="";const i=document.getElementById("cacheFoundLink");i.setAttribute("class","btn btn-outline-primary m-1 disabled placeholder col-4"),i.innerHTML=""}function foundCachePage(t){changePage("cache",`Cache ${t}`),Swal.fire({title:`Found Cache ${t}?`,text:"If you've found this cache, please enter the 5-digit code below to mark it as found:",input:"number",inputAttributes:{autocomplete:"off"},showCancelButton:!0,buttonsStyling:!1,customClass:{cancelButton:"btn btn-outline-primary m-1",confirmButton:"btn btn-primary m-1",loader:"custom-loader"},loaderHtml:'<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Verifying code...</span></div>',returnFocus:!1,confirmButtonText:"Verify cache code",backdrop:!0,showLoaderOnConfirm:!0,allowOutsideClick:()=>!Swal.isLoading(),inputValidator:t=>t?5!==t.length||Number.isNaN(Number(t))?"This code is invalid":void 0:"You must enter the 5-digit code from the cache to confirm you have found it",preConfirm:e=>fetch("./api/found-cache",{method:"POST",body:JSON.stringify({cache:t,cacheCode:Number(e)}),headers:{"Content-Type":"application/json","Device-Id":localStorage.getItem("deviceId")}}).then(t=>t.json()).then(handleErrors)}).then(e=>{e.isConfirmed?Swal.fire({title:"You did it!",text:e.value.success,icon:"success",buttonsStyling:!1,returnFocus:!1,showConfirmButton:!0,customClass:{confirmButton:"btn btn-primary m-1"},didOpen:()=>{Swal.hideLoading()},didClose:()=>{router.navigate(`viewCache-${t}`)}}):router.navigate(`viewCache-${t}`)}).catch(e=>{Swal.fire({title:e,icon:"error",buttonsStyling:!1,customClass:{confirmButton:"btn btn-primary m-1"},didOpen:()=>{Swal.hideLoading()},didClose:()=>{router.navigate(`viewCache-${t}`)}})})}function foundCachesPage(){const t='<div class="p-3 text-center">\n\t\t<i class="bi bi-emoji-frown home-icon d-block mx-auto mb-4" aria-hidden="true"\n\t\t\trole="img"></i>\n\t\t<h1 class="display-6 fw-bold">You haven\'t found any geocaches (yet)</h1>\n\t\t<div class="col-lg-6 mx-auto">\n\t\t\t<p class="lead mb-4">Get outside and go find some!</p>\n\t\t\t<div class="d-grid gap-2 d-sm-flex justify-content-sm-center">\n\t\t\t\t<button id="findCachesBtn" class="btn btn-primary btn-lg px-4 gap-3">Find caches</button>\n\t\t\t</div>\n\t\t</div>\n\t</div>',e='<div class="text-center"><img src="./img/loading.gif" class="img-fluid text-center" alt="Loading animation placeholder"></div>',n=document.getElementById("foundContainer");n.innerHTML=e,fetch("./api/found-caches",{method:"GET",headers:{"Device-Id":localStorage.getItem("deviceId")}}).then(t=>t.json()).then(handleErrors).then(e=>{if(e.found.length>0){n.innerHTML='<div class="row">\n\t\t\t\t\t<div class="col-md-6">\n\t\t\t\t\t\t<div class="card stat-card mb-2">\n\t\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t\t\t<div class="row">\n\t\t\t\t\t\t\t\t\t<div class="col">\n\t\t\t\t\t\t\t\t\t\t<p class="card-title text-muted mb-0">Device ID</p>\n\t\t\t\t\t\t\t\t\t\t<p class="h5 font-weight-bold mb-0" id="foundCachesDeviceId"></p>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="col-auto">\n\t\t\t\t\t\t\t\t\t\t<div class="icon rounded-circle shadow">\n\t\t\t\t\t\t\t\t\t\t\t<img id="foundCachesProfilePic" src="./img/loading.gif" alt="Loading placeholder...">\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="col-md-6">\n\t\t\t\t\t\t<div class="card stat-card mb-2">\n\t\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t\t\t<div class="row">\n\t\t\t\t\t\t\t\t\t<div class="col">\n\t\t\t\t\t\t\t\t\t\t<p class="card-title text-muted mb-0">Caches found</p>\n\t\t\t\t\t\t\t\t\t\t<p class="h5 font-weight-bold mb-0" id="foundCachesTotal"></p>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="col-auto">\n\t\t\t\t\t\t\t\t\t\t<div class="icon icon-shape bg-primary text-white rounded-circle shadow">\n\t\t\t\t\t\t\t\t\t\t\t<i class="bi bi-geo" aria-hidden="true"></i>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div id="wrapper"></div>',new gridjs.Grid({columns:[{id:"id",name:"Cache Number",sort:!0},{id:"date",name:"Found",sort:!0,formatter:t=>{const e=new Date(t);return`${e.toLocaleTimeString("en-GB",{hour12:!1})} on ${prettyDate(t)}`}}],data:e.found}).render(document.getElementById("wrapper"));const t=DOMPurify.sanitize(localStorage.getItem("deviceId"));document.getElementById("foundCachesDeviceId").innerText=t,document.getElementById("foundCachesProfilePic").setAttribute("src",`./profilePic/${t}/48`),document.getElementById("foundCachesProfilePic").setAttribute("alt",`Profile picture for ${t} (your device ID)`),document.getElementById("foundCachesTotal").innerText=Number(e.found.length)}else n.innerHTML=t,document.getElementById("findCachesBtn").onclick=function(){router.navigate("/viewCaches")}}).catch(t=>{showError(t,!0)}),changePage("found","Found caches")}function addCache(){function t(t){e.forEach(e=>{document.getElementById(e).removeAttribute("disabled"),t&&(document.getElementById(e).value="")}),n.removeAttribute("disabled"),n.innerText="Add cache"}const e=["editorPin","editorCacheLocation","editorCacheCode"],n=document.getElementById("saveBtn");n.setAttribute("disabled",!0),n.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>&nbsp;Adding cache...';const a={};e.forEach(t=>{a[t]=document.getElementById(t).value,document.getElementById(t).setAttribute("disabled",!0)}),fetch("./api/add-cache",{method:"POST",body:JSON.stringify({location:a.editorCacheLocation,code:a.editorCacheCode,pin:a.editorPin}),headers:{"Content-Type":"application/json","Device-Id":localStorage.getItem("deviceId")}}).then(t=>t.json()).then(handleErrors).then(e=>{t(!0),showToast.fire({title:e.success,icon:"success"})}).catch(e=>{t(!1),showError(e,!0)})}let mainMap,router;const showToast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:t=>{t.addEventListener("mouseenter",Swal.stopTimer),t.addEventListener("mouseleave",Swal.resumeTimer)}});window.onload=function(){router=new Navigo("/"),router.on("/",function(){changePage("home","Home")}).on("/home",function(){changePage("home","Home")}).on("/viewCaches",function(){loadCachesPage()}).on("/viewCache-:id",function(t){loadCachePage(t.data.id)}).on("/foundCaches",function(){foundCachesPage()}).on("/foundCache-:id",function(t){foundCachePage(t.data.id)}).on("/about",function(){changePage("about","About")}).on("/disclaimer",function(){window.scrollTo({top:0,left:0,behavior:"smooth"}),changePage("disclaimer","Disclaimer")}).on("/terms",function(){window.scrollTo({top:0,left:0,behavior:"smooth"}),changePage("terms","Terms and Conditions")}).on("/privacy",function(){window.scrollTo({top:0,left:0,behavior:"smooth"}),changePage("privacy","Privacy Policy")}).on("/openSourceLicenses",function(){window.scrollTo({top:0,left:0,behavior:"smooth"}),changePage("osl","Open Source Licenses")}).on("/editor",function(){changePage("editor","Cache editor")}).notFound(function(){changePage("404","Page not found")}).resolve(),null===localStorage.getItem("deviceId")&&getDeviceId();const t=document.getElementById("editorForm");t.addEventListener("submit",function(e){e.preventDefault(),t.checkValidity()?addCache():e.stopPropagation(),t.classList.add("was-validated")},!1)};